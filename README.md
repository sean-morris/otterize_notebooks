Instructor materials for Data 271 at Cal Poly Humboldt, Spring 2026

## Quick Start

### 1. Setup Environment (One-Time)

**Automated setup (recommended):**
```bash
./setup_environment.sh
```

**Manual setup:**
```bash
# Create environment from environment.yaml (references raw_notebooks/requirements.txt)
conda env create -f environment.yaml

# Activate environment
conda activate data271

# Install Jupyter kernel for nbclient
python -m ipykernel install --user --name data271 --display-name "Python (data271)"
```

**Verify setup:**
```bash
# Check kernel is registered
jupyter kernelspec list | grep data271

# Check otter-grader is installed
conda activate data271
python -c "import otter; print(otter.__version__)"
```

### 2. Generate Assignments (otter assign)

**Process notebooks from config file (required):**
```bash
# Default: processes notebooks listed in notebooks_to_otterize.txt
python3 otter_assign_runner.py

# Optional: clear outputs after otter assign to minimize git diffs
python3 otter_assign_runner.py --clear-outputs
```

**Process a single notebook from the config list:**
```bash
python3 otter_assign_runner.py --notebook hw01.ipynb
# or
python3 otter_assign_runner.py --notebook lab05.ipynb
```

This creates:
- Student notebooks in `otterized/student/` (empty, ready for students)
- Instructor notebooks in `otterized/instructor/` (with solutions and tests)
- Autograder zips in `autograder_zips/{hw,lab}/`

**Note:** The script automatically:
- Runs all cells using the `data271` kernel (via nbclient)
- Skips cells tagged with `otter_ignore` during pre-execution
- Copies autograder zips to `autograder_zips/{hw,lab}/` folder
- Organizes outputs into `otterized/student/` and `otterized/instructor/` folders

**Config File (`notebooks_to_otterize.txt`, required):**
The config file controls which notebooks are processed to avoid running helper/data preparation notebooks:
```
# One path per line, relative to raw_notebooks parent
# Lines starting with # are ignored
raw_notebooks/hw/hw01/hw01.ipynb
raw_notebooks/hw/hw02/hw02.ipynb
raw_notebooks/lab/lab01/lab01.ipynb
```

### 3. Grade Solutions (otter grade)

**Grade all notebooks:**
```bash
python3 otter_grade_runner.py --all
```

**Grade a single notebook:**
```bash
python3 otter_grade_runner.py --notebook hw01.ipynb
# or
python3 otter_grade_runner.py --notebook lab05.ipynb
```

Results are saved to `grading_results/` folder.

---

## Directory Structure

```
data271_sp26_private/
├── raw_notebooks/              # Original assignment notebooks
│   ├── hw/
│   │   ├── hw01/hw01.ipynb
│   │   ├── hw02/hw02.ipynb
│   │   └── ...
│   └── lab/
│       ├── lab01/lab01.ipynb
│       └── ...
├── otterized/                  # Generated by otter_assign_runner
│   ├── student/                # Student versions (for distribution)
│   │   ├── hw/
│   │   │   └── hw01/hw01.ipynb
│   │   └── lab/
│   │       └── lab01/lab01.ipynb
│   └── instructor/             # Instructor versions with autograder assets
│       ├── hw/
│       │   └── hw01/
│       │       ├── hw01.ipynb (solution)
│       │       ├── tests/      # Test files
│       │       └── requirements.txt
│       └── lab/
│           └── lab01/
│               ├── lab01.ipynb (solution)
│               ├── tests/
│               └── requirements.txt
├── autograder_zips/            # Autograder zips for Gradescope
│   ├── hw/
│   │   ├── hw01-autograder.zip
│   │   └── ...
│   └── lab/
│       ├── lab01-autograder.zip
│       └── ...
├── grading_results/            # Generated by otter_grade_runner (not committed)
│   ├── hw01_grading_results.csv
│   └── ...
├── discussion_worksheets/      # Worksheets for lab
├── env/                        # Environment configs
├── final_project/              # Final project prompt
├── grading_help/               # Grading utilities
├── past_exams/                 # Example midterms
├── environment.yaml            # Conda environment
├── notebooks_to_otterize.txt   # Required list of notebooks to process
├── otter_assign_runner.py      # Generate assignments
├── otter_grade_runner.py       # Grade assignments
├── setup_environment.sh        # Environment setup script
└── README.md
```

---

## Workflow Details

### Otter Assign Runner

The `otter_assign_runner.py` script:
1. Reads notebooks from `notebooks_to_otterize.txt` (required)
2. Pre-executes all cells using nbclient with the `data271` kernel
3. Skips cells tagged with `otter_ignore` (clears their source before execution)
4. Runs `otter assign` to generate student/instructor notebooks and autograder assets
5. Copies autograder zips to `autograder_zips/{hw,lab}/`
6. Organizes outputs into `otterized/student/` and `otterized/instructor/` folders

**Usage:**
```bash
# Process notebooks from config file (default)
python3 otter_assign_runner.py

# Process and clear outputs after otter assign to reduce git noise
python3 otter_assign_runner.py --clear-outputs

# Process single notebook from config list
python3 otter_assign_runner.py --notebook hw01.ipynb

# Process with more threads
python3 otter_assign_runner.py --threads 4

# Use different kernel
python3 otter_assign_runner.py --kernel-name python3

# Use custom config file
python3 otter_assign_runner.py --config custom_notebooks.txt
```

**Config File:**
Create `notebooks_to_otterize.txt` to control which notebooks are processed (required):
```
# Lines starting with # are ignored
# Paths relative to raw_notebooks parent directory
raw_notebooks/hw/hw01/hw01.ipynb
raw_notebooks/hw/hw02/hw02.ipynb
raw_notebooks/lab/lab01/lab01.ipynb
```

This prevents helper notebooks (like data cleaning scripts) from being executed.

### Otter Grade Runner

The `otter_grade_runner.py` script:
1. Finds autograder zips in `autograder_zips/{hw,lab}/`
2. Pairs them with instructor notebooks in `otterized/instructor/`
3. Runs `otter grade` on instructor notebooks using autograder zips
4. Moves `final_grades.csv` to `grading_results/` with assignment names

**Usage:**
```bash
# Grade all notebooks with default threads (1)
python3 otter_grade_runner.py --all

# Grade single notebook
python3 otter_grade_runner.py --notebook hw01.ipynb

# Grade with more threads (8 recommended for speed)
python3 otter_grade_runner.py --all --threads 8

# Grade with verbose output to see otter grade logs
python3 otter_grade_runner.py --notebook lab01.ipynb --verbose
```

---

## Controlling Cell Execution

### Skipping Cells During Pre-Execution

To prevent specific cells from running during notebook pre-execution, add the `otter_ignore` tag:

**In VS Code:**
1. Right-click on the cell
2. Select "Add Cell Tag"
3. Enter `otter_ignore`

The script will skip these cells entirely during pre-execution, which is useful for:
- Data preparation scripts that shouldn't run every time
- Cells that write to files
- Long-running computations
- Debug/testing code

---

## Environment Management

The `environment.yaml` file references `raw_notebooks/requirements.txt` for all Python packages. This ensures:
- Consistent package versions across otter assign, otter grade, and nbclient
- Single source of truth for dependencies
- Easy package updates (edit requirements.txt only)

To update packages:
1. Edit `raw_notebooks/requirements.txt`
2. Run `./setup_environment.sh` to update the environment
3. Verify: `conda activate data271 && python -c "import otter; print(otter.__version__)"`

---

## Troubleshooting

### Kernel Not Found
If you see "kernel 'data271' not found":
```bash
# Re-run kernel installation
python -m ipykernel install --user --name data271 --display-name "Python (data271)"

# Verify kernel is registered
jupyter kernelspec list | grep data271
```

### Import Errors During Execution
If notebooks fail with import errors:
```bash
# Update environment
conda env update -f environment.yaml --prune

# Verify packages are installed
conda activate data271
python -c "import pandas, numpy, matplotlib, datascience"
```

### Otter Assign Failures
If otter assign fails on specific notebooks:
```bash
# Run single notebook to see detailed errors
python3 otter_assign_runner.py --notebook problematic_notebook.ipynb

# Check for syntax errors in notebook
python3 -c "import nbformat; nb = nbformat.read('path/to/notebook.ipynb', as_version=4)"
```

---

## Notes

- The `data271` kernel must be installed for nbclient to execute notebooks correctly
- The `grading_results/` folder is not committed to git (in .gitignore)
- The `notebooks_to_otterize.txt` config file is required and lists all notebooks to process
- Autograder zips are stored in `autograder_zips/{hw,lab}/` for Gradescope uploads
- Student versions go to `otterized/student/` for distribution
- Instructor versions with tests go to `otterized/instructor/` for grading
- All notebooks are pre-executed before otter assign to ensure outputs are saved
- Cell execution uses the same environment as otter grade for consistency

